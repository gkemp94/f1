<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <script type="application/json" id="track-data">
      [
        [-1250.5708289348142, -1724.6949300723568],
        [-1405.6318839222952, -1611.037245659162],
        [-1622.331564372642, -1451.5027713512006],
        [-1797.6945313708275, -1329.5485594288841],
        [-2015.93930001808, -1183.075964865576],
        [-2145.0383984224136, -1096.5287361913533],
        [-2275.2066866471714, -1008.017625359795],
        [-2458.669478751617, -883.3444369300411],
        [-2698.3551482234034, -724.6126510462374],
        [-2875.402801405304, -611.7227555604975],
        [-2999.1559507075176, -534.9949376729534],
        [-3193.4724439223633, -414.70320701500333],
        [-3470.7288654377985, -240.27305844986745],
        [-3731.0654418873137, -63.25083678675082],
        [-3904.6739237083784, 65.76890991810447],
        [-4113.007277656198, 243.60651458273202],
        [-4320.087433958086, 471.5183590884219],
        [-4449.1104072623775, 699.1541918558495],
        [-4505.628359416049, 856.2774590200582],
        [-4558.967315498512, 1151.5958562865221],
        [-4568.793094755906, 1318.3545264119011],
        [-4569.9955564565025, 1467.4033576245563],
        [-4563.133092547541, 1614.7326031567934],
        [-4524.509071860257, 2027.3319063868742],
        [-4521.339586131045, 2108.4919603556364],
        [-4527.742072840314, 2406.4500247941364],
        [-4557.336761315879, 2623.5494361568444],
        [-4613.251911683612, 2820.718135395222],
        [-4705.738423267975, 3033.620096811634],
        [-4800.268126345075, 3190.416573928167],
        [-4900.026385456835, 3325.0170558700647],
        [-5115.276165858388, 3557.64665853723],
        [-5287.967750423191, 3717.7173198730825],
        [-5385.191040853021, 3808.3795049228424],
        [-5539.509696067755, 3958.085058102129],
        [-5630.7715410321725, 4049.956030959123],
        [-5733.619976537743, 4158.432753411714],
        [-5883.5698685580255, 4326.301838960859],
        [-6003.0494428139, 4481.226437832809],
        [-6056.382030425648, 4604.440215871774],
        [-6067.8893116314, 4676.0822599468265],
        [-6059.922758405312, 4820.4482324947085],
        [-6037.485650989117, 4894.2762502846645],
        [-5998.9884913472115, 4966.663878367823],
        [-5949.149037641071, 5029.441492644518],
        [-5921.074090571783, 5056.437739551387],
        [-5870.397048944782, 5095.2299739796235],
        [-5805.5191387592995, 5128.51445639958],
        [-5716.586049731954, 5160.637745086359],
        [-5620.343129445151, 5184.010812806884],
        [-5613.38229315272, 5185.254500110821],
        [-5464.961652880709, 5204.44599669776],
        [-5385.254683196099, 5214.233692223093],
        [-5307.790791642445, 5230.947324544157],
        [-5220.716886282327, 5259.003250929454],
        [-5165.62348738682, 5285.942393420271],
        [-5091.310060878386, 5335.566124039558],
        [-5055.4144846764575, 5367.838521055143],
        [-4999.578686008203, 5430.825532312054],
        [-4986.180505873877, 5448.303769325214],
        [-4938.422327392534, 5542.027599742797],
        [-4930.465284508441, 5629.358496157186],
        [-4943.923753294175, 5670.914116931558],
        [-4970.513900817968, 5716.013607556874],
        [-5015.407178698427, 5769.479424684717],
        [-5060.915952942177, 5811.9170432186465],
        [-5098.975297939661, 5841.606877478247],
        [-5113.350663981656, 5852.111583621621],
        [-5175.814182788028, 5892.95651988459],
        [-5223.797637062298, 5920.298577523126],
        [-5318.451059313496, 5966.02307485373],
        [-5372.221461569666, 5987.159390549937],
        [-5508.849298555667, 6031.418109019034],
        [-5576.541373396699, 6050.067050107368],
        [-5722.779224189162, 6082.983474512231],
        [-5852.642927285593, 6105.464991767124],
        [-5872.735442316082, 6107.7651743141305],
        [-5978.194971603625, 6119.091589565655],
        [-6143.408553532098, 6122.327690052914],
        [-6272.085673740645, 6110.829919189158],
        [-6462.991526620641, 6076.146272665743],
        [-6629.318708208237, 6025.310570003864],
        [-6827.19490772266, 5932.348160043019],
        [-6950.605388164486, 5855.994683913129],
        [-7152.174565858659, 5696.863082388808],
        [-7276.838243946417, 5570.435366417856],
        [-7400.629434616612, 5419.022879771426],
        [-7503.88711137654, 5281.335363306997],
        [-7570.668615067949, 5187.947833279085],
        [-7715.700819924458, 4985.7631168575435],
        [-7821.851970675336, 4844.972729421949],
        [-7949.187031196475, 4680.428564037462],
        [-8090.094769335452, 4503.403115774909],
        [-8232.966389631765, 4325.308477691933],
        [-8328.822231219481, 4204.8898012604495],
        [-8532.03801136531, 3949.642182858783],
        [-8620.2477213039, 3839.49661067111],
        [-8758.29688494863, 3666.573424206741],
        [-8887.770325110616, 3505.957023136925],
        [-8969.3681937238, 3407.049046523379],
        [-9080.690796093284, 3271.081115739368],
        [-9223.667114879705, 3095.984650137449],
        [-9398.332049579763, 2882.7590405446417],
        [-9438.596388976142, 2832.323111159201],
        [-9542.272859696499, 2706.628284619001],
        [-9707.25798159669, 2502.74618743639],
        [-9842.518369740576, 2335.9240444242437],
        [-9956.664647107606, 2194.85446101503],
        [-10140.010003780513, 1972.3202385087277],
        [-10257.1544536286, 1831.1459566094068],
        [-10288.843069542238, 1793.0168126185174],
        [-10428.101020994201, 1626.0550716195614],
        [-10555.819975979068, 1472.5042053322836],
        [-10676.438496684694, 1316.1994630408658],
        [-10831.312317247231, 1080.6509548639663],
        [-10870.634370232645, 1003.2314731490098],
        [-10929.465157146598, 854.0874537882428],
        [-10969.643818736862, 686.5831996547579],
        [-10973.971313963893, 495.31565723038307],
        [-10965.170314688226, 386.55655456881414],
        [-10942.552341317803, 283.28299899617565],
        [-10887.11627356191, 157.1408474695589],
        [-10830.112912689761, 72.07841834083268],
        [-10683.871877661939, -46.89031567778009],
        [-10643.058656660314, -69.47971565813836],
        [-10513.007761503019, -125.97542052838313],
        [-10355.70681261994, -160.50673212355684],
        [-10201.381831298568, -167.12489955560088],
        [-10169.366425337255, -167.00750648813994],
        [-9935.949970694566, -174.86617698876282],
        [-9787.852936234873, -203.71523909214446],
        [-9704.54180804791, -239.82972261628413],
        [-9682.066616899656, -253.05340526709648],
        [-9555.337500035734, -357.6943673177703],
        [-9499.787223447736, -429.79961519195086],
        [-9450.429994224716, -525.1351485644881],
        [-9435.832536625152, -570.653433150234],
        [-9423.871561962267, -655.2875579765347],
        [-9429.284125822436, -729.5216751495677],
        [-9444.424096556528, -783.0826804255223],
        [-9454.649606726283, -805.45317308367],
        [-9483.781049038642, -859.5027713134596],
        [-9524.905181275231, -913.9711635036791],
        [-9575.198328438504, -963.7566970291258],
        [-9617.055350105844, -997.2378818519444],
        [-9687.580610286417, -1040.7256695223073],
        [-9760.453647088052, -1074.2893479158843],
        [-9825.715451737264, -1096.5805312386312],
        [-9928.989007309901, -1119.1985046090542],
        [-10022.792147062886, -1126.4766206071656],
        [-10102.848111714522, -1126.2704078623085],
        [-10198.104335751657, -1120.5913426058742],
        [-10415.647930229503, -1080.1588741966978],
        [-10513.670724848133, -1052.5630097392484],
        [-10651.472450144665, -1003.3422366317573],
        [-10791.552153068855, -946.1961359015183],
        [-10879.999833377724, -906.2585865528148],
        [-11013.328096989699, -841.8724535565249],
        [-11127.38873891469, -784.8183567390402],
        [-11286.539361123001, -697.3193313118543],
        [-11388.781810607275, -634.8494863988441],
        [-11556.869845842708, -520.6461046157627],
        [-11656.567816303057, -445.0794804613967],
        [-11808.050101942892, -319.2895081371627],
        [-12015.152463164128, -119.3955062847101],
        [-12095.17671255442, -34.13637475312221],
        [-12238.200667778972, 135.97578892697692],
        [-12327.441526170003, 255.93440343061323],
        [-12401.412326182128, 368.42138376863414],
        [-12517.059324271442, 585.5176108959841],
        [-12616.10057276516, 814.2004285644869],
        [-12659.1949556298, 930.7674657813427],
        [-12721.036651966244, 1125.7279863854671],
        [-12758.83267980282, 1262.4922371229197],
        [-12791.736451994406, 1402.4291578249422],
        [-12837.949584642922, 1636.9592121267538],
        [-12860.964147054425, 1780.2433002768585],
        [-12896.358478089243, 2020.1542031774932],
        [-12945.829958508446, 2376.644837872337],
        [-12980.922888650295, 2636.5784568100557],
        [-13011.377369966069, 2849.645405367985],
        [-13050.642360899506, 3114.4363804539894],
        [-13086.315887907946, 3362.3424099707768],
        [-13118.908748864567, 3579.3371228433766],
        [-13160.648419828525, 3829.032537033988],
        [-13191.090206566947, 4013.08225211166],
        [-13219.974210531109, 4181.176613453729],
        [-13261.970872549336, 4466.88499691373],
        [-13288.488079208444, 4739.125401246001],
        [-13259.727879146538, 5090.343070067487],
        [-13188.977385537117, 5327.956974656472],
        [-13128.484117358796, 5458.147467800579],
        [-12978.397853951137, 5687.525133531852],
        [-12718.007399685006, 5938.765678283446],
        [-12537.679236177148, 6047.125050032653],
        [-12258.934873244936, 6173.930334360695],
        [-12138.370272720003, 6217.164315212144],
        [-11940.481378628228, 6281.109491692733],
        [-11786.971780308368, 6326.494546762385],
        [-11616.472537929183, 6372.472893275979],
        [-11334.704613361208, 6441.348409133616],
        [-11101.24374887982, 6489.525423939467],
        [-10925.224059915003, 6520.687405531287],
        [-10747.10089080604, 6548.921013635455],
        [-10616.669285420374, 6567.484319281751],
        [-10486.202780538004, 6585.048234101026],
        [-10140.216851986535, 6620.144348478233],
        [-9907.672884761409, 6637.270448653087],
        [-9657.999675490148, 6650.992276963808],
        [-9340.577286961803, 6673.083616012414],
        [-9118.306423980486, 6697.855847836396],
        [-8821.024144556686, 6752.263993739283],
        [-8691.046232628152, 6783.819380136827],
        [-8450.323130961366, 6853.262798283699],
        [-8245.578099067265, 6921.449834549281],
        [-8123.154314875104, 6968.751177702213],
        [-7971.272298322909, 7032.0903681615055],
        [-7775.185483482309, 7118.986634166831],
        [-7551.255323471984, 7210.857649387903],
        [-7383.9287510573695, 7261.728251546485],
        [-7292.543186918852, 7280.929258475419],
        [-7172.930383146883, 7294.111715522892],
        [-7045.763451638541, 7291.548215814976],
        [-6793.4854746919455, 7259.3329655795205],
        [-6626.260416532081, 7227.14943060541],
        [-6535.512553676204, 7207.304396287196],
        [-6326.823878654722, 7162.560269099621],
        [-6103.493336194977, 7128.333542632774],
        [-5914.94477027804, 7115.906222299481],
        [-5774.100462661752, 7122.825832988572],
        [-5278.478779924401, 7314.23938423455],
        [-5041.686626807643, 7467.596732354325],
        [-4844.194321756947, 7571.552441412379],
        [-4712.636422134805, 7615.170316727556],
        [-4456.072175564517, 7632.134613996252],
        [-4172.276895952438, 7556.993152273031],
        [-3967.3858976008128, 7449.078006003037],
        [-3865.584446996317, 7370.583008361019],
        [-3750.1849296192777, 7246.534826636554],
        [-3695.4944458714895, 7170.397115957594],
        [-3592.2367267474847, 6992.89262744728],
        [-3501.8092854685688, 6838.954724824995],
        [-3364.8165747028324, 6669.632554991699],
        [-3206.570155173428, 6522.06538145326],
        [-3074.5997876974934, 6410.603181096965],
        [-2970.79955543896, 6332.177982448352],
        [-2762.002997692012, 6198.38337316597],
        [-2568.244896424406, 6094.081895740324],
        [-2351.4659066386585, 5989.583715911818],
        [-2226.411965616457, 5932.913513558062],
        [-2057.6862290983845, 5857.75617302213],
        [-1845.2537975877385, 5763.112303477004],
        [-1660.293511360443, 5681.51761909918],
        [-1414.3925896043318, 5574.03396136697],
        [-1210.199581186756, 5486.106631637359],
        [-989.7022240665522, 5389.743176411815],
        [-679.7926953071628, 5254.47646216129],
        [-576.1098561160901, 5208.06666947399],
        [-441.9566991606094, 5148.712390109497],
        [-203.12131218703678, 5042.983217554409],
        [-39.497228294167314, 4970.649552016022],
        [95.65531948833247, 4911.330172148232],
        [216.5720992156474, 4858.517935115741],
        [337.48887894296234, 4805.705698083251],
        [534.6163525779995, 4719.53285353076],
        [703.342089096072, 4644.375512994828],
        [961.4799972533299, 4530.314913433915],
        [1189.14758764618, 4429.1988005501935],
        [1356.9088328339358, 4353.00716969054],
        [1508.4006288157661, 4284.2522734998],
        [1752.4423669046491, 4172.701253466109],
        [2070.8007157373236, 4024.721654437955],
        [2216.2961667570394, 3955.7573612669994],
        [2427.973503917584, 3854.082856436038],
        [2654.9557989537375, 3743.9373266124426],
        [2715.036641642344, 3714.0158904532786],
        [2879.0795194956436, 3629.689534990663],
        [3042.192805515329, 3543.329498377306],
        [3288.2111203389013, 3403.8304346837826],
        [3437.751728740749, 3304.989115192362],
        [3626.9792639077455, 3158.5038260517003],
        [3735.614647395216, 3056.2328455414386],
        [3883.508653345408, 2861.275509172672],
        [3970.6016217535953, 2688.209582850214],
        [4022.8904086996263, 2508.9252200080728],
        [4036.7835502585017, 2340.3073662154657],
        [4029.4197988183514, 2235.986825741752],
        [3988.625640864797, 2057.4543730143546],
        [3895.631558006685, 1855.0856487673043],
        [3819.4494374890273, 1744.359479713042],
        [3631.234030090481, 1546.670429895407],
        [3577.733313465936, 1502.7765428419675],
        [3488.987416499456, 1436.639066539837],
        [3383.321674467056, 1367.9095171397255],
        [3212.673323759066, 1268.8936578007147],
        [3064.5572686153823, 1183.6725676371093],
        [2991.0687354504553, 1139.0806906496198],
        [2820.9089776963, 1026.0733597323413],
        [2606.417518244284, 864.4892830968505],
        [2511.989371786012, 789.147892371333],
        [2273.4903275661886, 598.7083851617449],
        [2144.0263977461964, 495.12706022542176],
        [1972.8101447489707, 355.06637798522286],
        [1866.9128008170069, 264.3153308939889],
        [1772.7638503323547, 180.9788135523187],
        [1600.2119061184383, 21.859906605351917],
        [1415.261172597216, -154.702337858072],
        [1284.5313505539382, -279.34066915520106],
        [1176.1593265914546, -385.187277141829],
        [1078.7457022294784, -489.6505998377102],
        [997.0907292002438, -615.577028277474],
        [971.1668563491567, -675.5182729792707],
        [944.7099807055364, -777.5037314092745],
        [941.9465943594009, -841.639241822009],
        [946.3534412859117, -910.5274098929217],
        [965.1007547577148, -988.9208932801902],
        [999.4893264947984, -1056.7620764500277],
        [1032.1456179741103, -1103.6509517491668],
        [1095.8306191650704, -1179.4745669578037],
        [1130.3460943116106, -1222.2960799554617],
        [1170.3471165470812, -1278.934567047874],
        [1205.874677097994, -1350.7384140290856],
        [1224.2158911867205, -1446.1564409723812],
        [1214.5043631255073, -1540.5528721693086],
        [1190.6268660025141, -1630.4409421849755],
        [1146.3903524527652, -1739.050936517739],
        [1111.4370626618038, -1798.3068858628392],
        [808.3297938881219, -2087.0610782420304],
        [713.4130544760147, -2148.4109973892805],
        [497.5827195719503, -2243.0009891177897],
        [225.49460780384308, -2302.5329925652295],
        [68.76474544535755, -2313.0091676826173],
        [-131.7765103958091, -2301.000641309755],
        [-383.8926844362456, -2244.765111729139],
        [-595.2559261264676, -2152.0851243413495],
        [-702.3557317590277, -2093.787340219928],
        [-822.0764182564619, -2017.9193151725929],
        [-915.3243502975647, -1955.1353747892604],
        [-1013.7088344605729, -1888.5283685813638],
        [-1250.5708289348142, -1724.6949300723568]
      ]
    </script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/8.6.6/pixi.min.js"
      integrity="sha512-9Che/pADxtzmgRM/Lt7g+wgmgVPNu4qLCOjH+owFqCSpd9HHCi1fMYp+XtfE8nOdRQWUsD0TUNQUc5Z1SwaLyw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"></script>
    <script>
      function downscale(points, count) {
        const segments = points.reduce((acc, p, i) => {
          if (i === 0) return acc;
          const [x1, y1] = points[i === 0 ? points.length - 1 : i - 1];
          const [x2, y2] = p;
          const dist = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
          return acc.concat({ x1, y1, x2, y2, dist, cummDist: (acc[acc.length - 1]?.cummDist || 0) + dist });
        }, []);

        const totalDist = segments[segments.length - 1].cummDist;
        const step = totalDist / count;
        const newPoints = [];
        let last = 0;
        for (let i = 0; i < count; i++) {
          const target = (i + 1) * step;
          while (segments[last].cummDist < target) last++;
          const { x1, y1, x2, y2, dist, cummDist } = segments[last];
          const ratio = (target - cummDist + dist) / dist;
          newPoints.push([x1 + (x2 - x1) * ratio, y1 + (y2 - y1) * ratio]);
        }
        return newPoints;
      }

      (async () => {
        const _points = JSON.parse(document.getElementById("track-data").textContent);
        const points = downscale(_points, 300);
        let colors = new Array(points.length).fill("#fff");
        // Create Pixi application
        const app = new PIXI.Application({
          width: 800,
          height: 600,
          backgroundColor: "#1099bb",
          resizeTo: window,
        });
        await app.init({ background: "#000", resizeTo: window });
        document.body.appendChild(app.canvas);

        // Create a Graphics object to draw points
        const pointsGraphics = new PIXI.Graphics();
        app.stage.addChild(pointsGraphics);

        // Function to calculate bounding box
        function getBoundingBox(points) {
          const xs = points.map((p) => p[0]);
          const ys = points.map((p) => p[1]);
          const minX = Math.min(...xs);
          const maxX = Math.max(...xs);
          const minY = Math.min(...ys);
          const maxY = Math.max(...ys);
          return { minX, maxX, minY, maxY };
        }

        // Function to draw points with equal scaling
        function drawPoints() {
          // Clear previous drawings
          pointsGraphics.clear();
          pointsGraphics.beginFill(0xff0000, 1); // Red color

          // Get current canvas dimensions
          const width = app.renderer.width;
          const height = app.renderer.height;

          // Calculate bounding box
          const { minX, maxX, minY, maxY } = getBoundingBox(points);
          const rangeX = maxX - minX || 1; // Avoid division by zero
          const rangeY = maxY - minY || 1;

          // Calculate scale to maintain aspect ratio
          const padding = 40; // Pixels
          const scale = Math.min((width - padding) / rangeX, (height - padding) / rangeY);

          // Calculate offsets to center the points
          const offsetX = (width - rangeX * scale) / 2;
          const offsetY = (height - rangeY * scale) / 2;

          // Draw each point
          points.forEach(([x, y], i) => {
            const px = (x - minX) * scale + offsetX;
            const py = height - ((y - minY) * scale + offsetY);
            pointsGraphics.beginFill(colors[i]);
            pointsGraphics.drawCircle(px, py, 5); // Radius 5
            pointsGraphics.endFill();
          });
        }

        // Initial draw
        drawPoints();

        // Redraw points on window resize
        window.addEventListener("resize", () => {
          drawPoints();
        });

        const ws = new WebSocket(`ws://localhost:3000?points=${points.length}`);

        ws.onmessage = (event) => {
          try {
            // Parse an array of hex color strings or numbers
            const newColors = JSON.parse(event.data);
            console.log(newColors);
            if (Array.isArray(newColors)) {
              // Convert hex strings to numbers if necessary
              colors = newColors.map((x) => (x.startsWith("r") ? "rgba(255, 255, 255, .25)" : x));
              // Redraw points with updated colors
              drawPoints();
            }
          } catch (err) {
            console.error("Error parsing WebSocket data:", err);
          }
        };
      })();
    </script>
  </body>
</html>
